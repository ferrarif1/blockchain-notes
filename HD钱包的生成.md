# 生成HD钱包
## 第一步：生成助记词（BIP39）
![image](https://github.com/alexwanng/MasteringEthereumCN/raw/develop/images/bip39-part1.png)
1. 先创建一个128位到256位的随机数列s，也就是熵
2. 取s的前n位为校验和（n为s的长度/32）
3. 将校验和添加到s的末尾
4. 将序列按照11位划分
5. 每11位的值映射到助记词字典（2048个单词）中的一个
6. 获取到的单词序列就是助记词

> 以128位的熵源为例，校验和长度为4（128/32）

> 校验和与熵组合在一起的长度为132 （128+4）

> 按照11位划分，可以得到12个单词 （132/11）

> 这12个单词组成的序列就是助记词

> 同理，如果是256位的熵源，校验和为8，校验和与熵组合长度为264，按照11位划分，可以的到24个单词。

## 第二步：生成种子
![image](https://github.com/alexwanng/MasteringEthereumCN/raw/develop/images/bip39-part2.png)

7. 字符串 "mnemonic"+密码（可选）组成盐(salt)
8. 通过密钥拉伸函数PBKDF2，生成512位的种子，其中第一个参数为助记词，第二个参数为盐

> PBKDF2使用2048轮HMAC-SHA512哈希算法

## 第三步：生成私钥
![image](https://learnblockchain.cn/images/3ec7468aa49d907b0ec66b5d8b41a0a1.png)

9. 512位的种子，左半边为主私钥（256位），右半边为主链编码(256位)。

> 主私钥是32个字节的数

> 到这一步，生成了主私钥就可以认为生成了一个钱包。

> 实际上，种子是由助记词和密码生成的，因此利用助记词的便利性就可以很方便的对钱包进行备份、恢复、导入和导出。

# 扩展

## 密钥树的生成（BIP32）

在第9步我们得到了主私钥和主链编码，私钥经过加密算法可以得到公钥。于是，我们可以得到扩展公钥和扩展私钥。
> 私钥为256位，而公钥为264位

* **扩展私钥**：私钥和链码的组合，能够生成子私钥。前缀为xprv 。
* **扩展公钥**：公钥和链码的组合，能够生成子公钥。前缀为xpub 。


### 正常的密钥衍生
![image](https://learnblockchain.cn/images/a9a6e6a31f39e812f579a4c8bdf09347.png)

由父公钥+父链编码+索引号经过HMAC-SHA512哈希算法，能够得到子私钥+子链编码。
子私钥又能推出子公钥。因此形成一个循环，能够得到无限的私钥和公钥。

### 强化的密钥衍生
![image](https://pic2.zhimg.com/80/v2-ec632b868d16a3b85a44ffec87a538b5_hd.jpg)

由于隐藏了父公钥，因此强化衍生更加安全。即使攻击者获得了链码，也无法获取子密钥。

> 用索引号来区分这两种衍生方式，索引号小于2^31，为正常衍生，大于或等于2^31并且小于2*32为强化衍生。为了方便表示，强化索引用i'，表示2^31+i

> 根据索引号可以得出：一个密钥可以拥有40亿左右子密钥（2^32=4294967296）。其中一半子私钥，一半子公钥。

## 密钥路径

### BIP43

BIP-43提出使用第一个强化子索引作为特殊的标识符表示树状结构的“purpose”。

基于BIP-43，HD钱包应该使用且只用第一层级的树的分支，而且有索引号码去识别结构并且有命名空间来定义剩余的树的目的地。

举个例子，HD钱包只使用分支m/i'/是为了表明那个被索引号“i”定义的特殊为目地。

### BIP44
BIP-44提议了多账户结构作为“purpose”。所有遵循BIP-44的HD钱包依据只使用树的第一个分支的要求而被定义：m/44'/。

BIP-44指定了包含5个预定义树状层级的结构：

> m / purpose' / coin_type' / account' / change / address_index

- 最顶层（第零层）：m代表私钥，M代表公钥。
- 第一层的purpose总是被设定为44'。
- 第二层的coin_type特指币种,如：Bitcoin is m/44'/0'、Bitcoin Testnet is m/44'/1'，以及 Litecoin is m/44'/2'。[更多请参考](https://github.com/satoshilabs/slips/blob/master/slip-0044.md)
- 第三层account，允许使用者以组织的形式或者目的进行划分，如两个不同作用的账户，一个为m/44'/60'/0'，另一个为m/44'/60'/1'
- 第四层change，一个HD钱包有两个子树，一个用来创建接收地址，另一个用来创建更改地址。但是以太坊不像比特币需要更改地址，所以以太坊只用一个子树。
> 1-3层使用强化派生，第4层使用正常派生。
- 第五层addreess_index，HD钱包衍生的可用的钱包。


HD路径 | 描述
---|---
m/0 | 主私钥下的第一个子私钥
m/44'/2'/0'/0/1 | Litecoin 主帐户中的第二个私钥，用于签署交易
M/44'/60'/0'/0/2 | 以太坊的主账户中的第三个接收公钥。
M/44'/0'/3'/1/14 | 第4个比特币账户的第15个变址公钥

# 总结几个标准

1. BIP-39：提出了助记词

2. 基于BIP-32：HD钱包的主协议

3. BIP-43，对32的改进，提出多用途HD钱包结构

4. BIP-44，也是对32协议的改进，提出多币种和多账户钱包


### 参考资料
1. https://github.com/alexwanng/MasteringEthereumCN/blob/develop/05wallets.asciidoc#hd_wallets_figure
2. https://learnblockchain.cn/2018/09/28/hdwallet/#more
3. https://zhuanlan.zhihu.com/p/42423246